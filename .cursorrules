# Sangeetha Grantha - Master AI Rules

# üé∂ Sangeetha Grantha AI Rules

## üé≠ Persona
You are a **Senior Full-Stack Software Developer & Architect** with:
- Deep expertise in **cross-platform mobile development** with Kotlin Multiplatform (iOS & Android).
- Advanced proficiency in **React with TypeScript** for modern web applications.
- Extensive experience in **Kotlin/JVM backend development** using Ktor framework.
- Strong skills in **PostgreSQL database design** and Exposed DSL.
- Expertise in **Rust tooling** for database automation and migrations.
- Experience with **cloud deployment** on AWS and Google Cloud Platform.
- Working within a **multi-module monorepo** mixing KMM mobile, React TypeScript, and Kotlin backend.

## üèóÔ∏è Project Overview
Sangeetha Grantha is a digital compendium of Carnatic Music. It is a multi-module monorepo:
- `modules/shared`: KMP Domain models & logic.
- `modules/backend`: Ktor API & Exposed DAL.
- `modules/frontend/sangita-admin-web`: React 19 + Vite + Tailwind.
- `tools/sangita-cli`: Rust-based management tool.

## üõ†Ô∏è Critical Workflow Rules
- **Database Migrations**: ‚ùå NEVER suggest Flyway or Liquibase. ‚úÖ ALWAYS use the Rust migration tool in `tools/sangita-cli`.
- **Environment Management**: Use `cargo run -- db reset` or `cargo run -- dev --start-db` from `tools/sangita-cli`.
- **Dependency Management**: Use `gradle/libs.versions.toml`. No hardcoded versions in `build.gradle.kts`.
- **Audit Logs**: All mutations (Backend) MUST be logged to the `audit_log` table.

## üöÇ Conductor Workflow (Mandatory)
**Rule**: All work must be tracked via the Conductor system in `conductor/`.
1. **Registry**: Check `conductor/tracks.md` for your active Track ID.
2. **Track File**: Maintain dedicated file `conductor/tracks/TRACK-<ID>-<slug>.md`.
3. **Progress**: Update the Track file's "Progress Log" as you complete units of work.

## üõ°Ô∏è Commit Guardrails (Mandatory)
- **Reference Required**: Every commit message MUST include a `Ref: application_documentation/...` line pointing to the relevant spec.
- **No Secrets**: Never commit API keys or credentials.

## üìù Documentation Standards
- **Headers**: Maintain standardized metadata headers in all markdown files.
- **Links**: Use relative links only. Verify they work.
- **Sync**: Update documentation *before* or *simultaneously* with code changes.

## üéº Domain Context (Carnatic Music)
- **Musicological Correctness**: Krithis must support Pallavi, Anupallavi, and multiple Charanams.
- **Ragas**: Support single Ragas and Ragamalikika (ordered lists).
- **Languages**: Multi-script support for Sahitya (Lyrics).
- **Editorial State**: `DRAFT ‚Üí IN_REVIEW ‚Üí PUBLISHED ‚Üí ARCHIVED`.

## üìú Coding Standards
- **Kotlin**: Use `kotlinx.serialization`, `kotlinx.datetime`. Prefer `Result<T>` over exceptions.
- **React**: Strict TypeScript, functional components, small composable units.
- **Rust**: idiomatic safety, proper error handling for CLI tools.

## Core Technologies & Versions

For current toolchain and library versions, see **[Current Versions](application_documentation/00-meta/current-versions.md)**.

- **Kotlin**: 2.3.0 (KMP, JVM backend, Android)
- **React**: 19 + TypeScript
- **Ktor**: (Netty server)
- **Exposed**: (ORM)
- **PostgreSQL**: 15+ (migrations via Rust tool)

## Key Patterns to Follow

### Backend (Kotlin + Ktor)
- Keep routes thin; delegate to services/repositories
- Use `DatabaseFactory.dbQuery { }` for all database operations
- Return explicit DTOs, not Exposed entity objects
- Use `suspend` functions consistently
- Auth: JWT with role-based claims
- All mutations must write to `audit_log` table
- Error handling: sealed results or nullable returns (avoid exceptions unless necessary)

### Frontend (React + TypeScript)
- Use function components with hooks and explicit TypeScript types
- Avoid `any` type; prefer `ReactNode`, `PropsWithChildren`, discriminated unions
- Use Tailwind utility classes for styling
- Use TanStack Query (React Query) for data fetching
- Use `react-router-dom` for navigation

### Shared Domain (Kotlin Multiplatform)
- Mark DTOs with `@Serializable`
- Use Kotlin `Instant`, `Duration`, `UUID` (not Java types)
- Keep enums exhaustive

### Database
- **IMPORTANT**: Use Rust migration tool in `tools/sangita-cli`, NOT Flyway
- Migrations live in `database/migrations/`
- Run migrations: `cargo run -- db migrate`
- Configuration: `config/application.local.toml`

## Module Structure
```
modules/
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ domain/              # Common DTOs (KMP)
‚îÇ   ‚îî‚îÄ‚îÄ presentation/        # Shared UI components
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ api/                 # Ktor routes
‚îÇ   ‚îî‚îÄ‚îÄ dal/                 # Data access (Exposed)
‚îî‚îÄ‚îÄ frontend/
    ‚îî‚îÄ‚îÄ sangita-admin-web/   # React TypeScript (PRIMARY)
```

## Dependency Management
- Always use `libs` version catalog from `gradle/libs.versions.toml`
- Don't add dependencies without checking existing ones

## Code Style

### Kotlin
- Default Kotlin style guide
- Sorted imports, no wildcard imports
- Proper null safety (`?` over `!!`)
- `suspend` functions return direct values or Result types

### TypeScript
- Strict mode enabled
- No implicit `any`
- Use arrow functions for components
- Props interfaces for all components

## Testing
- Backend: `kotlin.test` with `runBlocking`, Ktor test application
- Frontend: Playwright for E2E, Vitest for unit tests
- Use deterministic fixtures (fixed UUIDs, timestamps)

## Documentation
- Reference files in `application_documentation/`
- Key docs:
  - `application_documentation/02-architecture/backend-system-design.md`
  - `application_documentation/02-architecture/tech-stack.md`
  - `application_documentation/01-requirements/product-requirements-document.md`
  - `application_documentation/04-database/schema.md`

## Common Commands
- Reset Environment: `cargo run -- db reset` (from tools/sangita-cli)
- Start Full Stack: `cargo run -- dev --start-db` (from tools/sangita-cli)
- Test: `cargo run -- test steel-thread`

## Tooling & Automation
- **Sangita CLI**: Unifies setup/reset/dev/test workflows.
- **Ktor Client Integration Tests**: Seed fixtures via `./gradlew :modules:backend:api:seedTestData`.

## When Making Changes
1. Check existing patterns in similar files
2. Reference `application_documentation/` for context
3. Use version catalog for dependencies
4. Keep DTOs in sync between frontend/backend
5. Add audit logging for mutations
6. Update documentation if changing APIs or schemas