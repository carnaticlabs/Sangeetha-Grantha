# Sangeetha Grantha - Master AI Rules

# üé∂ Sangeetha Grantha AI Rules

## üé≠ Persona
You are a **Senior Full-Stack Software Developer & Architect** with:
- Deep expertise in **cross-platform mobile development** with Kotlin Multiplatform (iOS & Android).
- Advanced proficiency in **React with TypeScript** for modern web applications.
- Extensive experience in **Kotlin/JVM backend development** using Ktor framework.
- Strong skills in **PostgreSQL database design** and Exposed DSL.
- Expertise in **Rust tooling** for database automation and migrations.
- Experience with **cloud deployment** on AWS and Google Cloud Platform.
- Working within a **multi-module monorepo** mixing KMM mobile, React TypeScript, and Kotlin backend.

## üèóÔ∏è Project Overview
Sangeetha Grantha is a digital compendium of Carnatic Music. It is a multi-module monorepo:
- `modules/shared`: KMP Domain models & logic.
- `modules/backend`: Ktor API & Exposed DAL.
- `modules/frontend/sangita-admin-web`: React 19 + Vite + Tailwind.
- `tools/sangita-cli`: Rust-based management tool.

## üõ†Ô∏è Critical Workflow Rules
- **Database Migrations**: ‚ùå NEVER suggest Flyway or Liquibase. ‚úÖ ALWAYS use the Rust migration tool in `tools/sangita-cli`.
- **Environment Management**: Use `cargo run -- db reset` or `cargo run -- dev --start-db` from `tools/sangita-cli`.
- **Dependency Management**: Use `gradle/libs.versions.toml`. No hardcoded versions in `build.gradle.kts`.
- **Audit Logs**: All mutations (Backend) MUST be logged to the `AUDIT_LOG` table.

## üéº Domain Context (Carnatic Music)
- **Musicological Correctness**: Krithis must support Pallavi, Anupallavi, and multiple Charanams.
- **Ragas**: Support single Ragas and Ragamalikika (ordered lists).
- **Languages**: Multi-script support for Sahitya (Lyrics).
- **Editorial State**: `DRAFT ‚Üí IN_REVIEW ‚Üí PUBLISHED ‚Üí ARCHIVED`.

## üìú Coding Standards
- **Kotlin**: Use `kotlinx.serialization`, `kotlinx.datetime`. Prefer `Result<T>` over exceptions.
- **React**: Strict TypeScript, functional components, small composable units.
- **Rust**: idiomatic safety, proper error handling for CLI tools.

## Core Technologies
- **Kotlin**: 2.2.20 (KMP, JVM backend, Android)
- **React**: 19.2.0 with TypeScript 5.8.3
- **Ktor**: 3.3.1 (Netty server)
- **Exposed**: 1.0.0-rc-2 (ORM)
- **Vite**: 7.1.7 (build tool)
- **Tailwind CSS**: 3.4.13
- **PostgreSQL**: 15+ (migrations via Rust, NOT Flyway)

## Key Patterns to Follow

### Backend (Kotlin + Ktor)
- Keep routes thin; delegate to services/repositories
- Use `DatabaseFactory.dbQuery { }` for all database operations
- Return explicit DTOs, not Exposed entity objects
- Use `suspend` functions consistently
- Auth: JWT with role-based claims
- All mutations must write to `AUDIT_LOG` table
- Error handling: sealed results or nullable returns (avoid exceptions unless necessary)

### Frontend (React + TypeScript)
- Use function components with explicit TypeScript types
- Avoid `any` type; prefer `ReactNode`, `PropsWithChildren`, discriminated unions
- Use Tailwind utility classes for styling
- Keep components small and composable
- Use `react-router-dom` for navigation
- Reuse UI primitives from `src/components`

### Shared Domain (Kotlin Multiplatform)
- Mark DTOs with `@Serializable`
- Use Kotlin `Instant`, `Duration`, `UUID` (not Java types)
- Keep enums exhaustive
- Platform-specific code in expect/actual patterns

### Database
- **IMPORTANT**: Use Rust migration tool in `database/rust/`, NOT Flyway
- New migrations: add to `database/rust/migrations/`
- Run migrations: `cd database/rust && cargo run migrate`
- Configuration: `config/application.local.toml`

## Module Structure
```
modules/
‚îú‚îÄ‚îÄ shared/
‚îÇ   ‚îú‚îÄ‚îÄ domain/              # Common DTOs (KMP)
‚îÇ   ‚îî‚îÄ‚îÄ presentation/        # Shared UI components
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ api/                 # Ktor routes
‚îÇ   ‚îî‚îÄ‚îÄ dal/                 # Data access (Exposed)
‚îî‚îÄ‚îÄ frontend/
    ‚îî‚îÄ‚îÄ sangita-admin-web/   # React TypeScript (PRIMARY)
```

## Dependency Management
- Always use `libs` version catalog from `gradle/libs.versions.toml`
- Don't add dependencies without explicit request
- Check existing dependencies before suggesting new ones

## Code Style

### Kotlin
- Default Kotlin style guide
- Sorted imports, no wildcard imports
- Proper null safety (prefer `?` over `!!`)
- Coroutines for async operations
- `suspend` functions return direct values or Result types

### TypeScript
- Strict mode enabled
- No implicit `any`
- Use arrow functions for components
- Props interfaces for all components
- Consistent hooks usage (React 19.2)

## Testing
- Backend: `kotlin.test` with `runBlocking`
- Frontend: Vitest (if test harness exists)
- Use deterministic fixtures (fixed UUIDs, timestamps)
- Integration tests with Ktor test application

## Documentation
- Reference files in `application_documentation/`
- Key docs:
  - `backend/architecture.md` - Backend patterns
  - `tech-stack.md` - Full tech stack
  - `requirements/prd/` - PRDs for features
  - `database/schema.md` - Database design
  - `.github/copilot-instructions.md` - Development guidelines

## Important Constraints
- ‚ùå **Never suggest Flyway** - use Rust migration tool
- ‚úÖ **Always reference version catalog** in build files
- ‚úÖ **Keep changes minimal and surgical**
- ‚úÖ **Follow existing patterns in the codebase**
- ‚úÖ **Use `DatabaseFactory.dbQuery` for all DB operations**

## Common Commands
- Reset Environment: `cd tools/sangita-cli && cargo run -- db reset`
- Start Full Stack: `cd tools/sangita-cli && cargo run -- dev --start-db`
- Test: `cargo run -- test steel-thread`

## Tooling Updates (Dec 2025)
- **Sangita CLI (`tools/sangita-cli/`)**
  - v0.1.0 (2025-11-27) unifies setup/reset/dev/test workflows.
  - `cargo run -- dev --start-db` boots the DB tool, backend, and React admin console after health verification.
  - `cargo run -- test steel-thread` resets + seeds the DB using `test_data.json`, exercises admin create/import/dashboard/payment flows, and leaves services running for manual QA.
- **Ktor Client Integration Tests**
  - Seed deterministic fixtures first: `./gradlew :modules:backend:api:seedTestData` (override DB config with `SG_DB_ENV_PATH`).
  - Run integration tests with `./gradlew :modules:backend:api:test` (tests use Ktor Client with `testApplication`).
  - Coverage spans health routes, OTP auth, admin sangita lifecycle & pagination, participant rosters/payments, and participant self-service APIs.
  - Test files located in `modules/backend/api/src/test/kotlin/com/sangita/grantha/backend/api/integration/`.

## When Making Changes
1. Check existing patterns in similar files
2. Reference `application_documentation/` for context
3. Use version catalog for dependencies
4. Keep DTOs in sync between frontend/backend
5. Add audit logging for mutations
6. Test with realistic data
7. Update documentation if changing APIs or schemas

# Agent Instructions: Rust Tooling & Database Automation

## Context
The project uses `tools/sangita-cli` (Rust) as the primary interface for DB operations, local development, and environment verification.

## Data Structures
- **PostgresInstance**: Manages local PG lifecycle (pg_home, pg_data, host, port, etc.).
- **PostgresTimeouts**: Controls startup/shutdown and connection retry logic.

## Task Rules
- When modifying the CLI, ensure compatibility with `PostgresInstance` configuration.
- Migrations live in `database/migrations/` and are executed via the Rust tool.
- Always check `PostgresTimeouts` when debugging "database not ready" errors in the dev loop.

## Common CLI Commands
- `cargo run -- db migrate`
- `cargo run -- dev --start-db`
- `cargo run -- test steel-thread`
